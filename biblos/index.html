<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biblos Scripture Viewer</title>
    <style>
        :root { 
            --primary: #1967d2; --bg: #f8f9fa; --surface: #ffffff; 
            --text: #202124; --border: #dadce0; --note-bg: #e8f0fe; 
            --strong-green: #188038; --hover: #f1f3f4;
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --primary: #8ab4f8; --bg: #202124; --surface: #2d2e31;
                --text: #e8eaed; --border: #3c4043; --note-bg: #3c4043;
                --strong-green: #81c995; --hover: #35363a;
            }
        }

        body { font-family: 'Charis SIL', 'Times New Roman', serif; margin: 0; background: var(--bg); color: var(--text); line-height: 1.6; padding-bottom: 140px; }
        .ui-font { font-family: 'Roboto', 'Segoe UI', Arial, sans-serif; }
        
        .container { max-width: 800px; margin: 2rem auto; padding: 0 1rem; }
        .card { background: var(--surface); padding: 2.5rem; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.12); position: relative; min-height: 70vh; }
        
        .sticky-nav { 
            position: sticky; top: 0; background: var(--surface); padding: 10px 0; 
            border-bottom: 1px solid var(--border); margin-bottom: 1.5rem; z-index: 1000; 
            display: flex; gap: 8px; flex-wrap: wrap; align-items: center; 
        }
        select, input { border: 1px solid var(--border); padding: 8px; border-radius: 8px; outline: none; font-size: 0.9rem; background: var(--surface); color: var(--text); }
        #col-select { max-width: 150px; }
        #search-box { flex-grow: 1; min-width: 150px; }
        
        #search-results { 
            position: absolute; top: 60px; left: 0; width: 100%; background: var(--surface); 
            z-index: 2000; border: 1px solid var(--border); border-radius: 8px; 
            max-height: 450px; overflow-y: auto; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2); 
        }
        .search-item { padding: 12px; border-bottom: 1px solid var(--border); cursor: pointer; font-size: 0.95rem; }
        .search-item:hover { background: var(--hover); }
        .search-nav-indicator { padding: 15px; text-align: center; background: var(--bg); color: var(--primary); cursor: pointer; font-weight: 500; border-top: 1px solid var(--border); }

        .ref { font-size: 2.2rem; color: var(--primary); margin-bottom: 1.5rem; font-weight: 400; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .verse-row { margin-bottom: 1rem; font-size: 1.4rem; transition: background-color 0.8s ease; padding: 4px; border-radius: 4px; }
        .v-num { font-size: 0.75rem; color: #9aa0a6; font-weight: bold; margin-right: 10px; vertical-align: super; font-family: sans-serif; }
        
        .strong-pill { font-size: 0.65rem; color: var(--strong-green); background: rgba(129, 201, 149, 0.15); padding: 1px 4px; border-radius: 4px; margin-left: 2px; vertical-align: super; font-family: sans-serif; font-weight: bold; }
        .strongs-hidden .strong-pill { display: none !important; }
        .fn-chip { background: var(--note-bg); color: var(--primary); font-size: 0.75rem; font-weight: 600; padding: 2px 10px; border-radius: 12px; margin: 0 4px; cursor: pointer; vertical-align: middle; }

        /* --- Semantic USFM Layout --- */
        .usfm-s { display: block; font-weight: bold; font-size: 1.1rem; text-align: center; margin: 1.5rem 0 0.5rem; color: var(--primary); }
        .usfm-d { display: block; font-style: italic; font-size: 0.9rem; text-align: center; margin-bottom: 0.5rem; opacity: 0.8; }
        .usfm-q { display: block; padding-left: 1.5rem; margin: 0.2rem 0; border-left: 2px solid var(--border); }
        .usfm-p, .usfm-ip { display: block; margin-top: 0.8rem; }

        .bottom-bar { 
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); 
            width: calc(100% - 40px); max-width: 760px; background: var(--surface); 
            border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); 
            padding: 12px 20px; z-index: 1000; display: flex; align-items: center; box-sizing: border-box; overflow-x: auto;
        }
        .bottom-bar.is-note { background: var(--note-bg); border: 1px solid var(--primary); }
        .ui-group { display: flex; gap: 10px; width: 100%; min-width: max-content; justify-content: space-between; align-items: center; }
        
        button { background: var(--primary); color: white; border: none; padding: 8px 14px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 6px; font-weight: 500; white-space: nowrap; }
        button.secondary { background: var(--hover); color: var(--text); }
        button.active { background: var(--primary) !important; color: var(--surface) !important; outline: 2px solid var(--primary); }

        #note-display { display: none; width: 100%; justify-content: space-between; align-items: center; }
        #qrcode { float: right; width: 80px; height: 80px; padding: 5px; background: white; border-radius: 8px; margin-left: 10px; }
        #cache-status { font-size: 0.7rem; color: #9aa0a6; position: absolute; bottom: 5px; right: 10px; }
    </style>
</head>
<body class="strongs-hidden">

<div class="container">
    <div class="card">
        <div class="sticky-nav ui-font">
            <select id="col-select" onchange="loadCollection(this.value)"></select>
            <select id="book-select" onchange="navigateTo(this.value, 1)"></select>
            <select id="chapter-select" onchange="changeChapter(this.value)"></select>
            <div style="position: relative; flex-grow: 1; display: flex;">
                <input type="text" id="search-box" placeholder="Search keywords or 'John 3'..." onkeyup="handleSearch(event)">
                <div id="search-results"></div>
            </div>
        </div>

        <div id="qrcode"></div>
        <h1 class="ref" id="ref-header">Biblos</h1>
        <div id="content"></div>
        <div id="cache-status" class="ui-font"></div>
    </div>
</div>

<div class="bottom-bar ui-font" id="bottom-bar">
    <div id="standard-controls" class="ui-group">
        <div style="display: flex; gap: 6px;">
            <button class="secondary" onclick="stepChapter(-1)">â—€</button>
            <button class="secondary" onclick="stepChapter(1)">â–¶</button>
        </div>
        <div style="display: flex; gap: 6px;">
            <button id="strong-toggle" class="secondary" onclick="toggleStrongs()">S#</button>
            <button class="secondary" onclick="pickRandom()">ðŸŽ² Random</button>
            <button id="play-btn" onclick="speechControl.play()">ðŸ”Š Listen</button>
            <button id="restart-btn" class="secondary" onclick="speechControl.restart()">ðŸ”„ Restart</button>
        </div>
    </div>
    <div id="note-display" class="ui-group">
        <div id="note-content" style="flex-grow:1; font-size:0.9rem;"></div>
        <div style="cursor:pointer; font-weight:bold; padding-left:15px;" onclick="closeNote()">âœ•</div>
    </div>
</div>

<script src="bookdata/library_index.js"></script>
<script src="../js/qrcode.js"></script>

<script>
const state = { activeCollection: null, currentCollectionId: null, fullLibrary: {}, book: null, ch: 1, showStrongs: false, searchResults: [], searchPage: 0, notePinned: false, db: null };

async function initDB() {
    return new Promise((resolve) => {
        const timer = setTimeout(() => resolve(null), 150);
        try {
            if (!window.indexedDB) return resolve(null);
            const request = indexedDB.open("BiblosCache", 1);
            request.onupgradeneeded = (e) => e.target.result.createObjectStore("collections");
            request.onsuccess = (e) => { clearTimeout(timer); state.db = e.target.result; resolve(state.db); };
            request.onerror = () => resolve(null);
        } catch(e) { resolve(null); }
    });
}

window.onload = async () => {
    const idx = window.BIBLE_INDEX;
    if (idx) {
        const colSel = document.getElementById('col-select');
        idx.collections.forEach(c => colSel.add(new Option(c.name, c.id)));
    }
    const params = new URLSearchParams(window.location.search);
    const last = JSON.parse(localStorage.getItem('last_pos')) || {};
    const targetCol = params.get('col') || last.col || (idx ? idx.collections[0].id : null);
    
    state.showStrongs = localStorage.getItem('show_strongs') === 'true';
    document.body.classList.toggle('strongs-hidden', !state.showStrongs);
    document.getElementById('strong-toggle').classList.toggle('active', state.showStrongs);

    await initDB();
    if (targetCol) {
        await loadCollection(targetCol);
        if (params.get('q')) {
            document.getElementById('search-box').value = params.get('q');
            handleSearch({ target: { value: params.get('q') } });
        }
        if (params.get('book')) navigateTo(params.get('book'), params.get('ch') || 1, params.get('v'));
    }
};

async function loadCollection(id) {
    state.currentCollectionId = id;
    const colData = window.BIBLE_INDEX.collections.find(c => c.id === id);
    const varName = `COLLECTION_${id.toUpperCase().replace(/[^A-Z0-9]/g, '_')}`;
    
    let cachedData = null;
    if (state.db) {
        cachedData = await new Promise(r => {
            const req = state.db.transaction(["collections"]).objectStore("collections").get(id);
            req.onsuccess = () => r(req.result);
            req.onerror = () => r(null);
        });
    }

    if (cachedData) {
        window[varName] = cachedData;
        document.getElementById('cache-status').innerText = "âœ“ Offline";
    } else if (!window[varName]) {
        document.getElementById('cache-status').innerText = "â˜ Loading...";
        await new Promise(r => {
            const s = document.createElement('script');
            s.src = colData.file; 
            s.onload = () => {
                if (state.db) {
                    try { state.db.transaction(["collections"], "readwrite").objectStore("collections").put(window[varName], id); } catch(e){}
                }
                r();
            };
            document.head.appendChild(s);
        });
    }

    state.activeCollection = window[varName];
    populateBooks();
    if (!state.book) navigateTo(Object.keys(state.activeCollection)[0], 1);
}

function populateBooks() {
    const sel = document.getElementById('book-select'); sel.innerHTML = "";
    Object.keys(state.activeCollection).forEach(code => sel.add(new Option(state.activeCollection[code].name, code)));
}

function parseUSFM(usfm) {
    const chapters = {}; let curCh = 0, curV = 0;
    const metaIgnore = ['\\h', '\\toc', '\\id', '\\mt', '\\rem'];

    usfm.split('\n').forEach(line => {
        line = line.trim();
        if (!line) return;
        const tag = line.split(' ')[0];

        if (line.startsWith('\\c ')) { 
            curCh = parseInt(line.split(' ')[1]); chapters[curCh] = {}; curV = 0; return;
        }
        if (line.startsWith('\\v ')) {
            const m = line.match(/\\v\s+(\d+)\s+(.*)/);
            if (m) { curV = parseInt(m[1]); chapters[curCh][curV] = finalize(m[2]); } return;
        }

        if (metaIgnore.some(m => tag.startsWith(m))) return;

        let content = finalize(line);
        if (content) {
            if (curCh === 0) { curCh = 1; chapters[curCh] = {}; }
            const cleanTag = tag.replace('\\', '');
            const wrapped = `<span class="usfm-${cleanTag}">${content}</span>`;

            if (curV === 0) { curV = 1; chapters[curCh][curV] = wrapped; }
            else { chapters[curCh][curV] = (chapters[curCh][curV] || "") + wrapped; }
        }
    });
    return chapters;
}

function finalize(raw) {
    if (!raw) return "";
    raw = raw.replace(/\\x\s+.*?\\x\*/g, ''); 
    let html = raw.replace(/\\\+?w\s+([^|]+)\|strong="([HG])([0-9]+)"\\\+?w\*/g, (m, word, lang, code) => {
        return `${word}<span class="strong-pill">${lang}${code}</span>`;
    });
    html = html.replace(/\\f\s+\+\s+(.*?)\s+(.*?)\\f\*/g, (m, r, n) => {
        const escaped = n.replace(/'/g, "\\'").replace(/"/g, '&quot;');
        return `<span class="fn-chip" onmouseover="handleNote(event, '${escaped}', 'hover')" onmouseout="handleNote(event, null, 'out')" onclick="handleNote(event, '${escaped}', 'click')">Note</span>`;
    });
    return html.replace(/\\[\+a-z0-9]+\*?\s?/gi, '').trim();
}

function navigateTo(code, ch, v) {
    state.book = code;
    state.fullLibrary = parseUSFM(state.activeCollection[code].usfm);
    document.getElementById('book-select').value = code;
    const chSel = document.getElementById('chapter-select'); chSel.innerHTML = "";
    Object.keys(state.fullLibrary).sort((a,b)=>a-b).forEach(c => chSel.add(new Option(`Chapter ${c}`, c)));
    changeChapter(ch || 1, v);
}

function changeChapter(c, v) {
    state.ch = parseInt(c);
    document.getElementById('chapter-select').value = c;
    render(v);
}

function render(targetV) {
    const verses = state.fullLibrary[state.ch];
    if (!verses) return;
    document.getElementById('ref-header').innerText = `${state.activeCollection[state.book].name} ${state.ch}`;
    let html = "";
    Object.keys(verses).sort((a,b)=>a-b).forEach(v => {
        html += `<div id="v-${v}" class="verse-row"><span class="v-num">${v}</span>${verses[v]}</div>`;
    });
    document.getElementById('content').innerHTML = html;
    updateQR();
    if (targetV) {
        setTimeout(() => {
            const el = document.getElementById(`v-${targetV}`);
            if (el) { el.scrollIntoView({ behavior: 'smooth', block: 'center' }); el.style.backgroundColor = 'rgba(25,103,210,0.2)'; setTimeout(()=>el.style.backgroundColor='transparent',2000); }
        }, 300);
    }
    localStorage.setItem('last_pos', JSON.stringify({ col: state.currentCollectionId, book: state.book, ch: state.ch }));
}

function handleSearch(e) {
    const q = e.target.value.trim().toLowerCase();
    const resDiv = document.getElementById('search-results');
    if (q.length < 2) { resDiv.style.display = 'none'; return; }
    state.searchResults = []; state.searchPage = 0;

    const refMatch = q.match(/^([1-3]?\s?[a-z]+)\s?(\d+)?:?(\d+)?/);
    if (refMatch) {
        const bQ = refMatch[1].replace(/\s/g, '');
        const tB = Object.keys(state.activeCollection).find(k => k.toLowerCase().includes(bQ) || state.activeCollection[k].name.toLowerCase().replace(/\s/g,'').includes(bQ));
        if (tB) state.searchResults.push({ code: tB, ch: refMatch[2] || 1, v: refMatch[3] || null, text: `Jump to Reference`, isJump: true });
    }

    for (const code in state.activeCollection) {
        const lib = parseUSFM(state.activeCollection[code].usfm);
        for (const ch in lib) {
            for (const v in lib[ch]) {
                const txt = lib[ch][v].replace(/<[^>]*>/g, '').toLowerCase();
                if (txt.includes(q)) state.searchResults.push({ code, ch, v, text: txt });
            }
        }
    }
    renderSearchResults();
}

function renderSearchResults() {
    const resDiv = document.getElementById('search-results');
    const start = state.searchPage * 100, end = start + 100;
    const pageItems = state.searchResults.slice(start, end);

    let html = pageItems.map(m => `
        <div class="search-item" onclick="navigateTo('${m.code}', ${m.ch}, ${m.v || 'null'}); document.getElementById('search-results').style.display='none';">
            <strong>${state.activeCollection[m.code].name} ${m.ch}${m.v?':'+m.v:''}</strong> - ${m.text.substring(0, 90)}...
        </div>`).join('');

    if (state.searchResults.length > end) {
        html += `<div class="search-nav-indicator" onclick="event.stopPropagation(); state.searchPage++; renderSearchResults();">Next 100</div>`;
    }
    resDiv.innerHTML = html; resDiv.style.display = html ? 'block' : 'none';
}

function updateQR() {
    const container = document.getElementById('qrcode');
    const url = new URL(window.location);
    url.searchParams.set('col', state.currentCollectionId); url.searchParams.set('book', state.book); url.searchParams.set('ch', state.ch);
    const sq = document.getElementById('search-box').value;
    if (sq) url.searchParams.set('q', sq); else url.searchParams.delete('q');
    window.history.replaceState(null, '', url);
    if (container && typeof QRCode !== 'undefined') { container.innerHTML = ""; new QRCode(container, { text: url.href, width: 80, height: 80 }); }
}

function stepChapter(dir) {
    const chs = Object.keys(state.fullLibrary).map(Number).sort((a,b)=>a-b);
    const idx = chs.indexOf(state.ch);
    if (chs[idx + dir]) changeChapter(chs[idx + dir]);
}

function toggleStrongs() {
    state.showStrongs = !state.showStrongs;
    document.body.classList.toggle('strongs-hidden', !state.showStrongs);
    document.getElementById('strong-toggle').classList.toggle('active', state.showStrongs);
    localStorage.setItem('show_strongs', state.showStrongs);
}

const speechControl = {
    play: () => { window.speechSynthesis.cancel(); window.speechSynthesis.speak(new SpeechSynthesisUtterance(document.getElementById('content').innerText)); },
    restart: function() { this.play(); }
};

function pickRandom() {
    const codes = Object.keys(state.activeCollection);
    const code = codes[Math.floor(Math.random() * codes.length)];
    const lib = parseUSFM(state.activeCollection[code].usfm);
    const ch = Object.keys(lib)[Math.floor(Math.random() * Object.keys(lib).length)];
    const v = Object.keys(lib[ch])[Math.floor(Math.random() * Object.keys(lib[ch]).length)];
    navigateTo(code, ch, v);
}

function handleNote(e, t, type) {
    if (type === 'click') state.notePinned = true;
    if (type === 'out' && state.notePinned) return;
    if (t) {
        document.getElementById('note-content').innerText = t;
        document.getElementById('bottom-bar').classList.add('is-note');
        document.getElementById('note-display').style.display = 'flex';
        document.getElementById('standard-controls').style.display = 'none';
    } else { closeNote(); }
}

function closeNote() { 
    state.notePinned = false; 
    document.getElementById('bottom-bar').classList.remove('is-note'); 
    document.getElementById('note-display').style.display = 'none'; 
    document.getElementById('standard-controls').style.display = 'flex'; 
}

document.addEventListener('keydown', (e) => { 
    if (e.key === 'Escape') { 
        closeNote(); 
        document.getElementById('search-results').style.display='none'; 
    } 
});
</script>
</body>
</html>