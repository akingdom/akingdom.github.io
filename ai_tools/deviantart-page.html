<!DOCTYPE html>
<!--PYKELET

DESCRIPTION: This tool provides a web page to display a DeviantArt user's artwork metadata by authenticating via the DeviantArt API (Implicit Grant Flow).

FILENAME:   deviantart-page.html
AUTHOR:     Andrew Kingdom
-->
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DeviantArt Gallery</title>
  <style>
    body { font-family: sans-serif; }
    #results { display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 1rem; }
    .thumb { width: 200px; border: 1px solid #ccc; padding: 0.5rem; border-radius: 4px; }
    .thumb img { max-width: 100%; height: auto; border-radius: 4px; }
    .tags { font-size: 0.8rem; color: #666; }
    .tag-pill { background-color: #eee; padding: 0.2rem 0.4rem; margin: 0 0.2rem; border-radius: 1em; display: inline-block; }
    #gdpr-banner { position: fixed; bottom: 0; left: 0; right: 0; background: #f8f8f8; padding: 1rem; border-top: 1px solid #ccc; display: none; }
    #gdpr-banner button { margin-left: 1rem; }
  </style>
</head>
<body>
  <h1>My DeviantArt Gallery</h1>
  <div>
    <label>Enter OAuth Access Token:
      <input type="text" id="access_token" placeholder="OAuth2 Access Token" />
    </label>
    <button onclick="loadGallery()">Load Gallery</button>
  </div>
  <div id="gdpr-banner">
    This site uses your access token temporarily to show your DeviantArt gallery. No data is stored. <button onclick="acceptGDPR()">Accept</button>
  </div>
  <div id="results"></div>

  <script>
    function acceptGDPR() {
      document.cookie = "gdpr_accept=true; max-age=31536000; path=/";
      document.getElementById('gdpr-banner').style.display = 'none';
    }

    function checkGDPR() {
      if (!document.cookie.includes("gdpr_accept=true")) {
        document.getElementById('gdpr-banner').style.display = 'block';
      }
    }

    async function loadGallery() {
      const token = document.getElementById('access_token').value.trim();
      if (!token) return alert("Access token required");

      try {
        const resp = await fetch(`https://www.deviantart.com/api/v1/oauth2/gallery/all?access_token=${token}&limit=24`);
        if (!resp.ok) throw new Error("Failed to load gallery");
        const data = await resp.json();
        const ids = data.results.map(item => item.deviationid);
        if (!ids.length) return alert("No deviations found");

        const detailsResp = await fetch(`https://www.deviantart.com/api/v1/oauth2/deviation/metadata?access_token=${token}&deviationids=${ids.join(',')}`);
        if (!detailsResp.ok) throw new Error("Metadata fetch failed");
        const meta = await detailsResp.json();

        const results = document.getElementById("results");
        results.innerHTML = "";
        meta.metadata.forEach(item => {
          const div = document.createElement("div");
          div.className = "thumb";
          div.innerHTML = `
            <img src="${item.thumb[0].src}" alt="${item.title}" />
            <div><strong>${item.title}</strong></div>
            <div class="tags">${item.tags.map(t => `<span class="tag-pill">${t.tag}</span>`).join(' ')}</div>
            <div>${item.description.slice(0, 100)}...</div>
          `;
          results.appendChild(div);
        });
      } catch (err) {
        alert("Error: " + err.message);
      }
    }

    checkGDPR();
  </script>
</body>
</html>
