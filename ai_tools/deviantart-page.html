<!DOCTYPE html>
<!--PYKELET

DESCRIPTION: This tool provides a web page to display a DeviantArt user's artwork metadata by authenticating via the DeviantArt API (Implicit Grant Flow).

FILENAME:   deviantart-page.html
AUTHOR:     Andrew Kingdom
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My DeviantArt Artwork</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.6; color: #333; }
        .artwork { border: 1px solid #ccc; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .artwork h3 { margin-top: 0; }
        .artwork img { max-width: 100%; height: auto; display: block; margin-bottom: 10px; border-radius: 4px; }
        #auth-button, .load-buttons button { padding: 10px 20px; font-size: 16px; cursor: pointer; background-color: #0077c9; color: white; border: none; border-radius: 5px; margin-top: 20px; }
        #auth-button:hover, .load-buttons button:hover { background-color: #005f9c; }
        #loading-message { font-style: italic; color: #555; }
        .error { color: red; }
        
        #setup-container {
            margin-top: 20px;
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
        }
        #setup-button {
            padding: 8px 12px;
            cursor: pointer;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .setup-content {
            display: none;
        }
        .setup-content.show {
            display: block;
        }
        .load-buttons {
            display: none;
            margin-top: 20px;
        }
        .load-buttons button {
            margin-right: 10px;
        }
    </style>
</head>
<body>

    <h1>My DeviantArt Artwork</h1>
    <p>This page uses the DeviantArt API to pull your artwork metadata. Your Client ID and Username are stored locally in your browser so you only have to enter them once. You can clear them by reloading the page and clicking 'Cancel' when prompted.</p>
    
    <div id="setup-container">
        <button id="setup-button">Show Setup Instructions</button>
        <div id="setup-content" class="setup-content">
            <h3>How to Get Your Client ID:</h3>
            <p>1. Go to the official <a href="https://www.deviantart.com/developers/apps" target="_blank">DeviantArt Developer Applications</a> page and click the **"Register Your Application"** button.</p>
            <p>2. On the registration form, fill in the following:</p>
            <ul>
                <li>**Application Name:** Give your app a simple name like "Portfolio Page."</li>
                <li>**Redirect URI:** Enter the exact URL of this page: <code>https://akingdom.github.io/ai_tools/deviantart-page.html</code></li>
            </ul>
            <p>3. After you click submit, you'll be taken back to the **Applications page**. A new entry for your app will now appear in the list.</p>
            <p>4. **Click on the new application entry** you just created to open a detailed view showing your app's information.</p>
            <p>5. You will see both a **Client ID** and a **Client Secret**. For this project, you only need the **Client ID**. The **Client Secret** is used for more advanced, server-side applications and should be kept private.</p>
            <p>6. Return to this page, click the **"Authorize with DeviantArt"** button below. You will be prompted to enter your **Client ID** and **DeviantArt Username**.</p>
        </div>
    </div>

    <button id="auth-button">Authorize with DeviantArt</button>
    <p id="loading-message" style="display:none;">Loading your artwork...</p>
    <p id="error-message" class="error" style="display:none;"></p>

    <div id="artwork-container"></div>
    <div class="load-buttons">
        <button id="load-more-button">Load More (50 items)</button>
        <button id="load-all-button">Load All Artwork</button>
    </div>

    <script>
        // --- IMPORTANT: ONLY REPLACE THIS VALUE ---
        const REDIRECT_URI = 'https://akingdom.github.io/ai_tools/deviantart-page.html';
        // --- END OF IMPORTANT REPLACEMENTS ---

        const CLIENT_ID_STORAGE_KEY = 'deviantart_client_id';
        const USERNAME_STORAGE_KEY = 'deviantart_username';
        const STATE_STORAGE_KEY = 'deviantart_auth_state';
        const authButton = document.getElementById('auth-button');
        const loadMoreButton = document.getElementById('load-more-button');
        const loadAllButton = document.getElementById('load-all-button');
        const loadingMessage = document.getElementById('loading-message');
        const errorMessage = document.getElementById('error-message');
        const artworkContainer = document.getElementById('artwork-container');
        const setupButton = document.getElementById('setup-button');
        const setupContent = document.getElementById('setup-content');
        const setupContainer = document.getElementById('setup-container');
        const loadButtonsContainer = document.querySelector('.load-buttons');

        let CLIENT_ID = localStorage.getItem(CLIENT_ID_STORAGE_KEY);
        let DEVIANTART_USERNAME = localStorage.getItem(USERNAME_STORAGE_KEY);
        let currentOffset = 0;
        let accessToken = null;
        const fetchLimit = 50;

        // Toggle setup instructions visibility
        setupButton.addEventListener('click', () => {
            setupContent.classList.toggle('show');
            if (setupContent.classList.contains('show')) {
                setupButton.textContent = 'Hide Setup Instructions';
            } else {
                setupButton.textContent = 'Show Setup Instructions';
            }
        });

        // Function to prompt the user for the Client ID
        function promptForClientId() {
            let userInput = prompt('Please enter your DeviantArt Client ID:', CLIENT_ID || '');
            if (userInput) {
                CLIENT_ID = userInput.trim();
                localStorage.setItem(CLIENT_ID_STORAGE_KEY, CLIENT_ID);
                return true;
            }
            localStorage.removeItem(CLIENT_ID_STORAGE_KEY);
            return false;
        }

        // Function to prompt the user for the DeviantArt Username
        function promptForUsername() {
            let userInput = prompt('Please enter your DeviantArt Username:', DEVIANTART_USERNAME || '');
            if (userInput) {
                DEVIANTART_USERNAME = userInput.trim();
                localStorage.setItem(USERNAME_STORAGE_KEY, DEVIANTART_USERNAME);
                return true;
            }
            localStorage.removeItem(USERNAME_STORAGE_KEY);
            return false;
        }

        authButton.addEventListener('click', () => {
            if (!CLIENT_ID) {
                if (!promptForClientId()) {
                    errorMessage.textContent = 'Client ID is required for authorization.';
                    errorMessage.style.display = 'block';
                    return;
                }
            }

            if (!DEVIANTART_USERNAME) {
                if (!promptForUsername()) {
                    errorMessage.textContent = 'Username is required to fetch artwork.';
                    errorMessage.style.display = 'block';
                    return;
                }
            }
            
            // Generate a random state string for CSRF protection
            const state = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
            localStorage.setItem(STATE_STORAGE_KEY, state);

            const authUrl = `https://www.deviantart.com/oauth2/authorize?client_id=${CLIENT_ID}&response_type=token&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=browse&state=${state}`;
            window.location.href = authUrl;
        });

        // Event listener for the "Load More" button
        loadMoreButton.addEventListener('click', () => {
            fetchGalleryMetadata(accessToken, currentOffset);
        });

        // Event listener for the "Load All" button
        loadAllButton.addEventListener('click', async () => {
            loadButtonsContainer.style.display = 'none';
            await fetchAllArtwork(accessToken, currentOffset);
        });

        function getAccessTokenFromUrl() {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            const returnedState = params.get('state');
            const storedState = localStorage.getItem(STATE_STORAGE_KEY);
            localStorage.removeItem(STATE_STORAGE_KEY); // Always remove the state to prevent replay attacks

            if (returnedState && storedState && returnedState === storedState) {
                return params.get('access_token');
            } else if (returnedState && storedState && returnedState !== storedState) {
                console.error('State mismatch. Possible CSRF attack.');
                errorMessage.textContent = 'Authorization failed due to a security error. Please try again.';
                errorMessage.style.display = 'block';
            }
            return null;
        }
        
        async function fetchAllArtwork(token, offset) {
            let nextOffset = offset;
            let page = 1;
            loadingMessage.style.display = 'block';

            while (nextOffset !== null) {
                loadingMessage.textContent = `Loading all artwork (Page ${page} of many)...`;
                const galleryUrl = `https://www.deviantart.com/api/v1/oauth2/gallery/all?username=${DEVIANTART_USERNAME}&access_token=${token}&limit=${fetchLimit}&offset=${nextOffset}`;
                const response = await fetch(galleryUrl);
                const data = await response.json();

                if (data.results && data.results.length > 0) {
                    const deviationIds = data.results.map(item => item.deviationid);
                    await fetchDeviationDetails(deviationIds, token);
                }
                
                nextOffset = data.has_more ? data.next_offset : null;
                page++;
            }
            loadingMessage.textContent = 'All artwork loaded.';
        }

        async function fetchGalleryMetadata(token, offset = 0) {
            try {
                authButton.style.display = 'none';
                loadButtonsContainer.style.display = 'none';
                loadingMessage.style.display = 'block';
                setupContainer.style.display = 'none';

                const galleryUrl = `https://www.deviantart.com/api/v1/oauth2/gallery/all?username=${DEVIANTART_USERNAME}&access_token=${token}&limit=${fetchLimit}&offset=${offset}`;
                const response = await fetch(galleryUrl);
                const data = await response.json();
                
                if (data.results && data.results.length > 0) {
                    // This line was removed in a previous version and has been correctly restored.
                    // The filter is no longer needed because the rendering function handles all content types.
                    const deviationIds = data.results.map(item => item.deviationid);

                    if (deviationIds.length > 0) {
                        await fetchDeviationDetails(deviationIds, token);
                    }
                    
                    if (data.has_more) {
                        currentOffset = data.next_offset;
                        loadButtonsContainer.style.display = 'flex';
                    } else {
                        loadingMessage.textContent = 'All artwork loaded.';
                        loadingMessage.style.display = 'block';
                    }

                } else {
                    errorMessage.textContent = 'No artwork found or an error occurred. Check your username and API setup.';
                    errorMessage.style.display = 'block';
                    loadingMessage.style.display = 'none';
                }
                
                loadingMessage.style.display = 'none';

            } catch (error) {
                console.error('Error fetching gallery:', error);
                errorMessage.textContent = 'Failed to fetch gallery. Please try again.';
                errorMessage.style.display = 'block';
                loadingMessage.style.display = 'none';
            }
        }

        async function fetchDeviationDetails(deviationIds, token) {
            try {
                const chunkSize = 10;
                for (let i = 0; i < deviationIds.length; i += chunkSize) {
                    const chunk = deviationIds.slice(i, i + chunkSize);
                    // Fetch metadata (including description and tags)
                    const metadataUrlBase = `https://www.deviantart.com/api/v1/oauth2/deviation/metadata?ext_submission=true&mature_content=true&deviationids[]=`;
                    const metadataUrl = `${metadataUrlBase}${chunk.join('&deviationids[]=')}&access_token=${token}`;
                    const metadataResponse = await fetch(metadataUrl);
                    const metadataData = await metadataResponse.json();

                    // Fetch media (including image previews) separately
                    const mediaUrlBase = `https://www.deviantart.com/api/v1/oauth2/deviation/media?mature_content=true&deviationids[]=`;
                    const mediaUrl = `${mediaUrlBase}${chunk.join('&deviationids[]=')}&access_token=${token}`;
                    const mediaResponse = await fetch(mediaUrl);
                    const mediaData = await mediaResponse.json();
                    
                    if (metadataData.metadata && mediaData.media) {
                        // Combine metadata and media data
                        const combinedData = metadataData.metadata.map(item => {
                            const mediaInfo = mediaData.media.find(mediaItem => mediaItem.deviationid === item.deviationid);
                            return { ...item, media: mediaInfo };
                        });
                        renderArtwork(combinedData);
                    }
                }

            } catch (error) {
                console.error('Error fetching artwork details:', error);
                errorMessage.textContent = 'Failed to fetch artwork details. Please try again.';
                errorMessage.style.display = 'block';
                loadingMessage.style.display = 'none';
            }
        }

        function renderArtwork(artworkList) {
            artworkList.forEach(artwork => {
                const div = document.createElement('div');
                div.className = 'artwork';

                // Safely access properties that may not exist
                const imageUrl = artwork.media && artwork.media.preview && artwork.media.preview.src ? artwork.media.preview.src : 'https://www.deviantart.com/favicon.ico';
                const tagsHtml = artwork.tags ? artwork.tags.map(tag => `<span>#${tag.tag_name}</span>`).join(' ') : 'No tags';
                const publishedDate = artwork.published_time ? new Date(artwork.published_time * 1000).toLocaleDateString() : 'N/A';
                const views = artwork.stats ? artwork.stats.views : 'N/A';
                const faves = artwork.stats ? artwork.stats.favourites : 'N/A';

                div.innerHTML = `
                    <h3>${artwork.title}</h3>
                    <img src="${imageUrl}" alt="${artwork.title}">
                    <p><strong>Description:</strong> ${artwork.description}</p>
                    <p><strong>Tags:</strong> ${tagsHtml}</p>
                    <p><strong>Published:</strong> ${publishedDate}</p>
                    <p><strong>Views:</strong> ${views} | <strong>Faves:</strong> ${faves}</p>
                `;
                artworkContainer.appendChild(div);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            accessToken = getAccessTokenFromUrl();
            if (accessToken) {
                authButton.style.display = 'none';
                setupContainer.style.display = 'none';
                fetchGalleryMetadata(accessToken);
            } else {
                authButton.style.display = 'block';
            }
        });
    </script>
</body>
</html>
